Backport of:

From 0ca3c33c59927e1c7e0c14dbc1eea1dfb2431a80 Mon Sep 17 00:00:00 2001
From: Andrew Murray <radarhere@users.noreply.github.com>
Date: Sat, 28 Oct 2023 15:58:52 +1100
Subject: [PATCH] Allow ops

---
 Tests/test_imagemath.py | 5 +++++
 src/PIL/ImageMath.py    | 9 +++++----
 2 files changed, 10 insertions(+), 4 deletions(-)

--- a/Tests/test_imagemath.py
+++ b/Tests/test_imagemath.py
@@ -65,6 +65,11 @@ def test_prevent_exec(expression):
         ImageMath.eval(expression)
 
 
+def test_prevent_double_underscores():
+    with pytest.raises(ValueError):
+        ImageMath.eval("1", {"__": None})
+
+
 def test_logical():
     assert pixel(ImageMath.eval("not A", images)) == 0
     assert pixel(ImageMath.eval("A and B", images)) == "L 2"
--- a/src/PIL/ImageMath.py
+++ b/src/PIL/ImageMath.py
@@ -240,13 +240,14 @@ def eval(expression, _dict={}, **kw):
 
     # build execution namespace
     args = ops.copy()
-    args.update(_dict)
-    args.update(kw)
-    for k, v in list(args.items()):
-        if '__' in k or hasattr(__builtins__, k):
+    for k in list(_dict.keys()) + list(kw.keys()):
+        if "__" in k or hasattr(__builtins__, k):
             msg = f"'{k}' not allowed"
             raise ValueError(msg)
 
+    args.update(_dict)
+    args.update(kw)
+    for k, v in list(args.items()):
         if hasattr(v, "im"):
             args[k] = _Operand(v)
 
